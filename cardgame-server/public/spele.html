<!DOCTYPE html>
<html lang="lv">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content=" width=device-width, initial-scale=1" />
    <title>Istaba</title>

    <!-- Core styles -->
    <link rel="stylesheet" href="/style.css" />
    <script src="/include_footer.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
  </head>

  <body>
    <div class="augsa">
      <div class="logo">
        <img  src="/resources/zolitelogo.png" alt="logo" height="40px" />
      </div>

      <!-- Room name -->
      <div class="room-title" id="roomNameHeader">Istaba</div>

      <div class="menu">
        <button class="poga">
          Iestatījumi <i class="fa fa-caret-down"></i>
        </button>
        <div class="iest">
          <label class="switch">
            <input type="checkbox" id="set1" /><span class="slider"></span> rave
          </label>
          <label class="switch">
            <input type="checkbox" id="set2" /><span class="slider"></span> light mode
          </label>
          <label class="switch">
            <input type="checkbox" id="set3" /><span class="slider"></span> barbie
          </label>
        </div>
      </div>

      <div class="podzinjas">
        <a href="/index.html">Iziet</a>
      </div>
    </div>

    <!-- Participants list -->
    <div class="participants-list">
      <h4 class="tekstinjs">Dalībnieki:</h4>
      <ul id="dalibnieki" class="tekstinjs"></ul>
    </div>

    <!-- Main Content -->
    <div class="content room-content">
      <button id="joinBtn" class="poga2">Pievienoties istabai</button>
    </div>



    <div id="updateButton" style="width:100px; height:100px; background-color:blue;"></div>
    <div id="textW"></div>



    <!-- Chat widget -->
    <div id="chat-container">
      <div id="chat-log"></div>
      <input
        type="text"
        id="chat-input"
        placeholder="Raksti ziņojumu… (Enter nosūta)"
      />
    </div>
    
    <!-- Card containers -->
    <div id="kartisUzGalda"></div>
    <div id="cardcontainer" ></div>

    <div id="acisSpeletaji"></div> <!-- punktu display -->
    


    <script type="text/javascript" src="/backend.js"></script><!--atsaucos uz js failu-->
    


    
    <!-- Scripts -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
      let cards = []; // Array for card objects
      let placedCards = [] // PRIEKS noliktam kartim
      let placedCardsPlayer = [] // lai katrai kartij pieliktu kada speletaja vertibu
      let container = document.getElementById("cardcontainer"); // Card container element
      let placedCardsContainer = document.getElementById("kartisUzGalda") // kartis kas noliktas uz galda
      let gajiensPecKartas = 1

      let punktiDiv = document.getElementById('acisSpeletaji')



      const socket        = io();
      const istabaID      = location.pathname.split('/').pop();
      const roomNameHead  = document.getElementById('roomNameHeader');
      const joinBtn       = document.getElementById('joinBtn');
      const ul            = document.getElementById('dalibnieki');
      const chatContainer = document.getElementById('chat-container');
      const chatLog       = document.getElementById('chat-log');
      const chatInput     = document.getElementById('chat-input');
      let   roomCreator   = null;
      let   isHovered     = false;

      // Join & fetch room info
      socket.emit('pievienoties-istabai', istabaID);
      socket.emit('spele-page-load', istabaID);

      socket.on('istabas-stats', ({ nosaukums, izveidotajs, dalibnieki }) => {
        roomCreator = izveidotajs;
        roomNameHead.innerText = nosaukums;
        updateMembers(dalibnieki);
      });

      socket.on('pievienots', () => {
        joinBtn.style.display = 'none';
      });

      socket.on('jauns-dalibnieks', ({ dalibnieki }) => {
        updateMembers(dalibnieki);
      });

      socket.on('chat-msg', ({ from, ziņojums }) => {
        const line = document.createElement('div');
        line.innerText = `${from}: ${ziņojums}`;
        chatLog.appendChild(line);
        chatLog.scrollTop = chatLog.scrollHeight;
        if (!isHovered) chatInput.classList.add('unread');
      });

      socket.on('kļūda', msg => alert(msg));

      joinBtn.addEventListener('click', () => {
        socket.emit('pievienoties-istabai', istabaID);
      });

      // Hover/focus to expand chat
      chatContainer.addEventListener('mouseenter', () => {
        isHovered = true;
        chatContainer.classList.add('expanded');
        chatInput.classList.remove('unread');
      });
      chatContainer.addEventListener('mouseleave', () => {
        isHovered = false;
        chatContainer.classList.remove('expanded');
      });
      chatInput.addEventListener('focus', () => {
        isHovered = true;
        chatContainer.classList.add('expanded');
        chatInput.classList.remove('unread');
      });
      chatInput.addEventListener('blur', () => {
        if (!isHovered) {
          chatContainer.classList.remove('expanded');
        }
      });

      // Send chat on Enter
      chatInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          const msg = chatInput.value.trim();
          if (!msg) return;
          socket.emit('chat-msg', { istabaID, ziņojums: msg });
          chatInput.value = '';
        }
      });

      function updateMembers(list) {
        ul.innerHTML = '';
        list.forEach((sid, idx) => {
          const li = document.createElement('li');
          li.innerText =
            `Anonīms #${idx + 1}` +
            (sid === roomCreator ? ' (Īpašnieks)' : '');
          ul.appendChild(li);
        });
      }


      // Updated displayCards function
      function displayCards() {
          container.innerHTML = "";
          
          for (let i = 0; i < 8; i++) {
              const img = document.createElement("img");
              img.src = "/resources/" + SavasKartis[i] + ".png"; // Image source
              img.id = "card" + i; // Optional ID
              img.classList.add("card"); // Add card class
              img.width = 150;
              img.height = 250;
              container.appendChild(img); // Add card to the container
          }
          
          // Wait a brief moment for images to load before arranging
          setTimeout(() => {
              arrangeCardsInArc();
              setupCardHoverEffects();
          }, 50);
      }

      function setupCardHoverEffects() {
          document.querySelectorAll(".card").forEach((card) => {
              let bounceAnimationFrame = null;
              let bouncing = false;
              let hoverOffset = -30; // Smaller offset for more subtle effect
              
              function startBounce() {
                  if (bouncing) return;
                  bouncing = true;
                  
                  let start = null;
                  
                  function animateBounce(timestamp) {
                      if (!start) start = timestamp;
                      const progress = timestamp - start;
                      
                      // Get original angle
                      const angle = parseFloat(card.dataset.angle || 0);
                      
                      // Apply bounce with original rotation
                      const bounceY = hoverOffset + Math.sin(progress / 300) * 3; // Reduced bounce amplitude
                      card.style.transform = `rotate(${angle}deg) translateY(${bounceY}px)`;
                      
                      if (bouncing) {
                          bounceAnimationFrame = requestAnimationFrame(animateBounce);
                      }
                  }
                  
                  bounceAnimationFrame = requestAnimationFrame(animateBounce);
              }
              
              function stopBounce() {
                  bouncing = false;
                  if (bounceAnimationFrame) {
                      cancelAnimationFrame(bounceAnimationFrame);
                      bounceAnimationFrame = null;
                  }
              }
              
              card.addEventListener("mouseenter", () => {
                  // Get original angle
                  const angle = parseFloat(card.dataset.angle || 0);
                  
                  card.style.transition = "transform 0.3s ease-out";
                  // Don't change z-index - keep original layering
                  
                  // Apply hover effect preserving rotation
                  card.style.transform = `rotate(${angle}deg) translateY(${hoverOffset}px)`;
                  
                  // Start bounce after transition
                  setTimeout(() => {
                      if (card.matches(':hover')) {
                          startBounce();
                      }
                  }, 300);
              });
              
              card.addEventListener("mouseleave", () => {
                  stopBounce();
                  card.style.transition = "transform 0.3s ease-out";
                  card.style.transform = card.dataset.baseTransform || '';
                  
                  // No need to reset z-index since we never changed it
              });
          });
      }

      // sakas kartis uz galda paradisana 
      function refresh() {
        
        placedCardsContainer.innerHTML = ""
        
        // Remove all previous images before adding new ones

        // Loop through placedCards and add the new images
        for (let i = 0; i < placedCards.length; i++) {
          
            const img = document.createElement("img");
            img.src = "/resources/" + placedCards[i] + ".png"; // Image source
            img.classList.add("placed"); // Add card class
            img.width = 150;
            img.height = 250;
            


      placedCardsContainer.appendChild(img);
            // Add card to the container  
        }
      }

      function arrangeCardsInArc() {
          const cards = document.querySelectorAll(".card");
          const total = cards.length;
          
          // Exit if no cards
          if (total === 0) return;
          
          // Get container dimensions
          const containerRect = container.getBoundingClientRect();
          const containerWidth = containerRect.width;
          
          // Calculate center point and base position
          const centerX = containerWidth / 2;
          const baseY = 200; // Position from the top
          
          // Adjust arc parameters based on number of cards
          const minRadius = 350; // Minimum radius
          const maxRadius = 500; // Maximum radius 
          const radius = minRadius + ((maxRadius - minRadius) * (1 - total/8)); // Dynamic radius
          
          // Increased spacing between cards
          const maxSpread = Math.min(75, total * 10); // Increased from 60 to 75 for wider spread
          const spread = total > 1 ? maxSpread : 0;
          const minAngle = -spread / 2;
          const maxAngle = spread / 2;
          
          // Flatter arc (less height difference between middle and outer cards)
          const peakOffset = 70; // Reduced from 80 to make arc flatter
          
          // Position each card
          cards.forEach((card, i) => {
              // Handle single card case
              if (total === 1) {
                  // Center single card with no rotation
                  card.style.position = 'absolute';
                  card.style.left = `${centerX - 75}px`; // 75 is half card width
                  card.style.top = `${baseY}px`;
                  card.style.transform = 'rotate(0deg)';
                  card.dataset.baseTransform = 'rotate(0deg)';
                  card.dataset.angle = 0; // Store angle for hover effect
                  card.style.zIndex = 10;
                  return;
              }
              
              // Calculate the angle for this card - dynamically adjusted
              const angle = minAngle + ((maxAngle - minAngle) / (total - 1)) * i;
              const radians = (angle * Math.PI) / 180;
              
              // Calculate x position with improved spacing
              const x = centerX + radius * Math.sin(radians) - 75; // 75 is half card width
              
              // Calculate y position with flatter arc effect - using a gentler curve
              // This makes the middle and outer cards more level with each other
              let arcOffset = 0;
              if (total > 1) {
                  const midpoint = (total - 1) / 2;
                  const distanceFromMid = Math.abs(i - midpoint);
                  // Using a linear function instead of squared for a flatter arc
                  const factor = 1 - (distanceFromMid / midpoint); 
                  arcOffset = peakOffset * factor;
              }
              
              // Calculate final y position - cards closer to middle rise slightly higher
              const y = baseY - arcOffset;
              
              // Set position with fixed pixel values
              card.style.position = 'absolute';
              card.style.left = `${Math.round(x)}px`;
              card.style.top = `${Math.round(y)}px`;
              
              // Adjust rotation - less dramatic when fewer cards
              // Cards should fan out, with rotation more extreme at edges
              const rotationFactor = Math.min(0.9, total / 7); // Reduced rotation factor slightly
              const rotationAngle = angle * rotationFactor;
              
              const baseTransform = `rotate(${rotationAngle}deg)`;
              card.style.transform = baseTransform;
              card.dataset.baseTransform = baseTransform;
              card.dataset.angle = rotationAngle; // Store angle for hover effect
              
              // Add z-index to create depth effect - middle cards appear in front
              const zIndex = Math.round(10 + (total / 2) - Math.abs(i - (total / 2)));
              card.style.zIndex = zIndex;
              card.dataset.zIndex = zIndex; // Store original z-index
          });
      }

      let playerGajiens = 1
      let mansPlayerId = null;//sakuma speles kods
      let dalitajs = 0 // pasaka vai kartis speles sakuma jau izdalitas vai ne
      socket.on('player-id', ({ playerId }) => {
        mansPlayerId = playerId;
        console.log('Mans Player ID:', mansPlayerId);

        // Tu vari tagad izmantot šo playerId visur
      });


      let SavasKartis = []
      socket.on('kartes-dati', ({kartes, dalitajsRefresh}) =>{
        SavasKartis = kartes
        console.log(SavasKartis)
        displayCards()
        dalitajs = dalitajsRefresh
        setTimeout(Spele, delayGajiens);
      });

      socket.on('updatedUzvaretajs',GajUzvaretajs =>{
          playerGajiens = GajUzvaretajs; 
        })


      let delayGajiens = 600



      function Spele(){
        if(dalitajs == 0){
          
          if(mansPlayerId == 1){
            
            socket.emit('spelesSakums', {istabaID})
            
          }
        }else{
          if (placedCards.length === 3) {
            if(mansPlayerId ==1){
              
              const GajUzvaretajs = GajienaUzvaretajs(placedCards, placedCardsPlayer);
              console.log(placedCardsPlayer)
              
              socket.emit('gajienaUzvaretajs', { istabaID, GajUzvaretajs });
            }     
            
            gajiensPecKartas += 1;
            placedCards = [];
            placedCardsPlayer = [];
            placedCardsContainer.innerHTML = "";

            
            setTimeout(Spele, delayGajiens);
            console.log(playerGajiens)
            return
            
          }else{
            
            console.log(mansPlayerId, playerGajiens)
            if(mansPlayerId == playerGajiens ){

              console.log("strada")
              container.addEventListener("click", function playerClick(event) {
              if (event.target.classList.contains("card")) {
                const kartsVertiba = parseInt(event.target.src.split("/").pop().replace(".png", ""));
                // norada kurs nolika karti
                
                event.target.remove();
                arrangeCardsInArc();

                const jaunais = playerGajiens+1
                socket.emit('updateX', { istabaID, jaunais, kartsVertiba, mansPlayerId});
                refresh();
                setTimeout(Spele, delayGajiens);

              }else{
              Spele()
              }
              }, { once: true });
              return
            }
          setTimeout(Spele, delayGajiens);
          return
          }
          
        }
        
      }
    
  


      

    // Example button to update the value of x
    document.getElementById('updateButton').addEventListener('click', () => {

      Spele()
    });


    socket.on('updatedGajiens', ({jaunais, kartsVertiba, mansPlayerId}) =>{
      console.log("izmaina izdevas:")
      console.log(jaunais)
      playerGajiens = jaunais
      placedCards.push(kartsVertiba)
      placedCardsPlayer.push(mansPlayerId)
      refresh()
      console.log(placedCards)
    });
    </script>
  </body>
</html>
