<!DOCTYPE html>
<html lang="lv">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content=" width=device-width, initial-scale=1" />
    <title>Istaba</title>

    <!-- Core styles -->
    <link rel="stylesheet" href="/style.css" />
    <script src="/include_footer.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
  </head>

  <body>
    <div class="augsa">
      <div class="logo">
        <img  src="/resources/zolitelogo.png" alt="logo" height="40px" />
      </div>

      <!-- Room name -->
      <div class="room-title" id="roomNameHeader">Istaba</div>

      <div class="menu">
        <button class="poga">
          Iestatījumi <i class="fa fa-caret-down"></i>
        </button>
        <div class="iest">
          <label class="switch">
            <input type="checkbox" id="set1" /><span class="slider"></span> rave
          </label>
          <label class="switch">
            <input type="checkbox" id="set2" /><span class="slider"></span> light mode
          </label>
          <label class="switch">
            <input type="checkbox" id="set3" /><span class="slider"></span> barbie
          </label>
        </div>
      </div>

      <div class="podzinjas">
        <a href="/index.html">Iziet</a>
      </div>
    </div>

    <!-- Participants list -->
    <div class="participants-list">
      <h4 class="tekstinjs">Dalībnieki:</h4>
      <ul id="dalibnieki" class="tekstinjs"></ul>
    </div>

    <!-- Main Content -->
    <div class="content room-content">
      <button id="joinBtn" class="poga2">Pievienoties istabai</button>
    </div>

    <!-- Chat widget -->
    <div id="chat-container">
      <div id="chat-log"></div>
      <input
        type="text"
        id="chat-input"
        placeholder="Raksti ziņojumu… (Enter nosūta)"
      />
    </div>
    <!-- Scripts -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket        = io();
      const istabaID      = location.pathname.split('/').pop();
      const roomNameHead  = document.getElementById('roomNameHeader');
      const joinBtn       = document.getElementById('joinBtn');
      const ul            = document.getElementById('dalibnieki');
      const chatContainer = document.getElementById('chat-container');
      const chatLog       = document.getElementById('chat-log');
      const chatInput     = document.getElementById('chat-input');
      let   roomCreator   = null;
      let   isHovered     = false;

      // Join & fetch room info
      socket.emit('pievienoties-istabai', istabaID);
      socket.emit('spele-page-load', istabaID);

      socket.on('istabas-stats', ({ nosaukums, izveidotajs, dalibnieki }) => {
        roomCreator = izveidotajs;
        roomNameHead.innerText = nosaukums;
        updateMembers(dalibnieki);
      });

      socket.on('pievienots', () => {
        joinBtn.style.display = 'none';
      });

      socket.on('jauns-dalibnieks', ({ dalibnieki }) => {
        updateMembers(dalibnieki);
      });

      socket.on('chat-msg', ({ from, ziņojums }) => {
        const line = document.createElement('div');
        line.innerText = `${from}: ${ziņojums}`;
        chatLog.appendChild(line);
        chatLog.scrollTop = chatLog.scrollHeight;
        if (!isHovered) chatInput.classList.add('unread');
      });

      socket.on('kļūda', msg => alert(msg));

      joinBtn.addEventListener('click', () => {
        socket.emit('pievienoties-istabai', istabaID);
      });

      // Hover/focus to expand chat
      chatContainer.addEventListener('mouseenter', () => {
        isHovered = true;
        chatContainer.classList.add('expanded');
        chatInput.classList.remove('unread');
      });
      chatContainer.addEventListener('mouseleave', () => {
        isHovered = false;
        chatContainer.classList.remove('expanded');
      });
      chatInput.addEventListener('focus', () => {
        isHovered = true;
        chatContainer.classList.add('expanded');
        chatInput.classList.remove('unread');
      });
      chatInput.addEventListener('blur', () => {
        if (!isHovered) {
          chatContainer.classList.remove('expanded');
        }
      });

      // Send chat on Enter
      chatInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          const msg = chatInput.value.trim();
          if (!msg) return;
          socket.emit('chat-msg', { istabaID, ziņojums: msg });
          chatInput.value = '';
        }
      });

      function updateMembers(list) {
        ul.innerHTML = '';
        list.forEach((sid, idx) => {
          const li = document.createElement('li');
          li.innerText =
            `Anonīms #${idx + 1}` +
            (sid === roomCreator ? ' (Īpašnieks)' : '');
          ul.appendChild(li);
        });
      }
    </script>
  </body>
</html>
